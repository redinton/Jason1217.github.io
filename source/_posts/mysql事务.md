---
title: mysql事务,隔离级别
date: 2020/11/04 13:56:13
toc: true
tags:
- mysql
---


### 事务 (transaction)
把多条语句作为一个整体进行操作 -- 成为数据库事务
* 确保该事务范围内的所有操作全部成功或全部失败
* 单条SQL语句, 数据库系统自动作为一个事务执行, 这种事务称为**隐式事务**。
* 手动将多条SQL语句作为一个事务执行,  使用BEGIN开启一个事务, 使用COMMIT提交一个事务, 成为**显式事务**。
* 主动让事务失败,  用ROLLBACK回滚事务, 整个事务会失败。
<!--more-->
```SQL
BEGIN;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
UPDATE accounts SET balance = balance + 100 WHERE id = 2;
ROLLBACK;
```

数据库事务具有ACID 四个属性

* A: Atomic ,  原子性 
  * 所有SQL作为原子工作单元执行, 要么全部执行, 要么全部不执行
* C: Consistent  一致性
  * 事务完成后,  所有数据状态都是一致 , A账户减去100,  B账户肯定加上100
* I: Isolation  隔离性 
  * 多个事务并发, 每个事务作出的修改必须与其他事务隔离
* D: Duration  持久性
  * 事务完成后,  对数据库数据的修改被持久化存储



### 事务隔离级别

事务支持并发执行。 但若涉及到操作同一条记录的时候, 可能会有问题。

并发操作会带来数据的不一致性, 包括**脏读(dirty read), 不可重复读(Non repeatable read ), 幻读(phantom  read)**.

![image-20200307113840232](mysql_4/image-20200307113840232.png)

#### read uncommitted

>SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

一个事务可能读取到另一个事务更新但未提交的数据, 这个数据有可能是脏数据。 例如一个事务更新了数据, 然后这个时候另一个事务读了就可以读到,  但是原来那个事务可能下一步就回滚导致数据更新失效。

**脏读**  
对于两个事务 T1,T2, T1读取了已经被T2更新但还没有提交的字段。之后, 若T2 rollback, 则T1读取的内容就是临时且无效的。

#### read commited

在这个级别, 事务对其余事务更新数据的操作只能读到commit后的结果。

事务可能遇到不可重复读情况。 即指, 在一个事务内, 多次读同一数据。

在这个事务还没有结束时, 如果另一个事务恰好修改了这个数据, 那么, 在第一个事务中, 两次读取的数据就可能不一致。

**不可重复读**  
对于两个事务T1, T2, T1读取了一个字段, 然后T2**更新**了该字段, 之后, T1再次读取同一个字段, 值就不同了

#### repeatable read

这个级别就是, 某个事务在读数据的时候保持一致, 例如起初事务A读数据的时候是空, 然后在这期间事务B插入并commit了这条数据,  这个之后事务A再读数据的时候也是空的。这就是保持 repeatable read。(同样的select的语句保证结果一样 ) 但是这个时候如果事务A去update 这条数据, 是可以成功的, 并且之后再读这条数据也是成功的。--  这个情形就是幻读。

**幻读**  
对于两个事务T1,T2,  T1从一个表中读取了一个字段, 然后T2在该表中**插入**了一些新的行, 之后如果T1再次读取同一个表, 就会多出几行。
* 不可重复读重点在于update和delete, 而幻读重点在insert  

在RR(repeatable read)级别, 解决了脏读(读到uncomitted data)和不可重复读(同一个事务中对同一份数据多次读到结果不一样,由于另一个事务修改了这个数据),但还是会有幻读。样例如下，事务T1先读取数据发现没有id=1的数据，然后准备insert数据之前，另一个干扰事务T2插入了id=1的数据并且commit了。此时事务T1插入数据不成功，但读取id=1的时候也读取不到id=1的数据。因为解决不可重复读的问题就是保证一个事务中读到的数据一致。 但在RR级别，可以通过对SQL加锁来避免幻读。

![image-20201104144623826](mysql_4/image-20201104144623826.png)


#### Serializable

确保事务可以从一个表中读取相同的行



  

