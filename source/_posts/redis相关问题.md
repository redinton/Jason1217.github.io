---
title: redis相关问题
date: 2020/11/20 17:32:47
toc: true
tags:
- redis
---

[redis是单线程为什么这么快](#redis是单线程为什么这么快)  
[redis单线程原因](#redis单线程原因)  
[redis与memcached,mongodb区别](#redis与memcached,mongodb区别)  
[memcache与redis的区别](#memcache与redis的区别)  
[如果有大量的key需要设置同一时间过期一般需要注意什么](#如果有大量的key需要设置同一时间过期一般需要注意什么)  

<!--more-->

#### redis是单线程,为什么这么快
  * 完全**基于内存**，内存操作比较快
  * 单线程，避免了不必要的上下文切换和竞争条件，不存在多进程或多线程导致的切换消耗CPU，不考虑各种锁的时间
    * CPU上下文指的是寄存器和程序计数器
      * 寄存器一般存临时变量,程序计数器存当前运行的指定的地址
  * 多路I/O复用，非阻塞IO
    * 多路指的是**多个网络连**接
    * 复用指的是**复用同一个线**程
    * 利用select,poll,epoll同时监察多个流的I/O事件的能力

#### redis 单线程原因
  * reids通过I/O多路复用同时**监听多个文件描述符(客户端连接)的可读和可写状态**，一旦收到网络请求会在内存中快速处理
  * redis是基于内存的操作，**CPU不是redis瓶颈**，r**edis瓶颈最有可能是内存大小或者网络带宽**
  * 单线程指的是在处理网络请求的时候只有一个线程处理，起redis server时肯定不止一个线程
  * 新版redis引入多线程
    * DEL 删除一个键对应的值，若删除的key-value很大，redis会在释放内存空间上消耗较多时间，这些操作会阻塞待处理的任务，因此可以改成后台线程异步执行


#### redis与memcached，mongodb区别
* memcached中key和value都是**字符串**
* mongodb由Json组成的文档
* redis的value有多种类型 string,list,hash,set,zset

#### Memcache与Redis的区别
* 存储方式
  * Memecache把数据**全部存在内存**之中，断电后会挂掉，数据不能超过内存大小。
  * Redis有部份存在硬盘上，这样能保证数据的持久性。
* 数据支持类型
  * Memcache对数据类型支持相对简单。
  * Redis有丰富的数据类型。
* 使用底层模型不同
  * 它们之间底层实现方式 以及与客户端之间通信的应用协议不一样。
  * Redis直接自己构建了VM 机制 ，因为一般的系统调用系统函数的话，会浪费一定的时间去移动和请求。

#### 如果有大量的key需要设置同一时间过期，一般需要注意什么
大量的key过期时间设置的过于集中，到过期的那个时间点，Redis可能会出现短暂的卡顿现象(因为redis是单线程的)。严重的话可能会导致服务器雪崩，所以我们一般**在过期时间上加一个随机值，让过期时间尽量分**散。


#### redis缓存刷新策略
* 内存不够时
* 设置的时间过期时


#### redis过期时间和过期删除机制
* KEY的过期时间设置
  * EXPIRE KEY TTL
* 过期键的删除策略
  * 立即删除
    * 设置键的过期时间时，创建一个回调事件，过期时间到达时，由处理器自动执行键的删除操作
    * 对CPU不友好, 删除操作会占用CPU的时间，好处是节省内存
    * redis事件处理器对时间事件处理方式--无序链表，查找一个key复杂度O(n)
  * 惰性删除
    * 每次从dict字典中按key取值时，先检查此key是否已经过期，如果过期就删除它并返回NIL，若没有过期，就返回value
    * 浪费内存
  * 定时删除
    * 每隔一段时间，对expires字典进行检查，删除里面的过期key-value
  * redis的策略就是惰性+定期

#### redis用rdb的方式做持久化,将内存中的数据复制到磁盘中时,对redis的读写会受到影响吗
RDB保存快照的方式有SAVE和BGSAVE
* SAVE
  * 直接阻塞当前的线程，直接阻塞来自客户端的其他请求。
* BGSAVE
  * fork 出一个子进程，子进程会执行『将内存中的数据以 RDB 格式保存到磁盘中』这一过程
    * 通过 fork 生成的父子进程会共享包括内存空间在内的资源

#### 当aof文件太大的时候，怎么办？aof文件的压缩怎么实现的？
* AOF重写文件会开一个子进程重写
  * 子进程进行AOF重写期间，主进程可以继续处理命令请求
* AOF重写可以由用户手动触发，也可以由服务器自动触发