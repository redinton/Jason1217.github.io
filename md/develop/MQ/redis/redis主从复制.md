---
title: redis主从复制
date: 2020/11/07 17:50:33
toc: true
tags:
- redis
---

数据的复制是单向的，只能由主节点到从节点

主从复制的作用
* 数据冗余：主从复制**实现了数据的热备份，**是持久化之外的一种数据冗余方式。
* 故障恢复：当主节点出现问题时，可以由**从节点提供服务**，实现快速的故障恢复；实际上是一种服务的冗余。
* 负载均衡：在主从复制的基础上，配合读写分离，可以由主**节点提供写服务，由从节点提供读服务，分担服务器负载**；尤其是在写少**读多的场景下**，通过多个从节点分担读负载，可以大大提高Redis服务器的并发量。
* 高可用基石：主从复制还是哨兵和集群能够实施的基础，因此说主从复制是Redis高可用的基础。
<!--more-->

主从复制过程主要可以分为3个阶段：连接建立阶段、数据同步阶段、命令传播阶段

#### 连接建立阶段
* 步骤1：保存主节点信息
  * slaveof命令是异步的，在从节点上执行slaveof命令，从节点立即向客户端返回ok，从节点服务器内部维护了两个字段，即masterhost和masterport字段，用于存储主节点的ip和port信息。
* 步骤2：建立socket连接
    * 从节点每秒1次调用复制定时函数replicationCron()，如果发现了有主节点可以连接，便会根据主节点的ip和port，创建socket连接。
    * 从节点为该socket建立一个专门处理复制工作的文件事件处理器，负责后续的复制工作，如接收RDB文件、接收命令传播等。
    * 主节点接收到从节点的socket连接后（即accept之后），为该socket创建相应的客户端状态，并将从节点看做是连接到主节点的一个客户端，后面的步骤会以从节点向主节点发送命令请求的形式来进行。
* 步骤3：发送ping命令
  * 从节点成为主节点的客户端之后，发送ping命令进行首次请求，目的是：检查socket连接是否可用，以及主节点当前是否能够处理请求。
  * 从节点发送ping命令后，可能出现3种情况：
    * 返回pong：说明socket连接正常，且主节点当前可以处理请求，复制过程继续。
    * 超时：一定时间后从节点仍未收到主节点的回复，说明socket连接不可用，则从节点断开socket连接，并重连。
    * 返回pong以外的结果：如果主节点返回其他结果，如正在处理超时运行的脚本，说明主节点当前无法处理命令，则从节点断开socket连接，并重连。

* 步骤4：身份验证
  * 如果从节点中设置了masterauth选项，则从节点需要向主节点进行身份验证；没有设置该选项，则不需要验证。从节点进行身份验证是通过向主节点发送auth命令进行的，auth命令的参数即为配置文件中的masterauth的值。
  * 如果主节点设置密码的状态，与从节点masterauth的状态一致（一致是指都存在，且密码相同，或者都不存在），则身份验证通过，复制过程继续；如果不一致，则从节点断开socket连接，并重连。

* 步骤5：发送从节点端口信息
  * 身份验证之后，从节点会向主节点发送其监听的端口号（前述例子中为6380），主节点将该信息保存到该从节点对应的客户端的slave_listening_port字段中；该端口信息除了在主节点中执行info Replication时显示以外，没有其他作用。

#### 数据同步阶段

主从节点之间的连接建立以后，便可以开始进行数据同步，该阶段可以理解为从节点数据的初始化。具体执行的方式是：从节点向主节点发送psync命令（Redis2.8以前是sync命令），开始同步。

数据同步阶段是主从复制最核心的阶段，根据主从节点当前状态的不同，可以分为全量复制和部分复.

#### 命令传播阶段

数据同步阶段完成后，主从节点进入命令传播阶段；在这个阶段**主节点将自己执行的写命令发送给从节点**，从节点接收命令并执行，从而保**证主从节点数据的一致性**。

需要注意的是，命令传播是异步的过程，即主节点发送写命令后并不会等待从节点的回复；因此实际上主从节点之间很难保持实时的一致性，延迟在所难免。数据不一致的程度，与主从节点之间的网络状况、主节点写命令的执行频率、以及主节点中的repl-disable-tcp-nodelay配置等有关。
